<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–í–∏–¥–µ–æ—á–∞—Ç –ø–æ –≥–æ—Ä–æ–¥–∞–º –†–æ—Å—Å–∏–∏</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .cities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .city-btn {
            padding: 15px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .city-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }
        
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .video-box {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e2e8f0;
        }
        
        .video-box h3 {
            text-align: center;
            margin-bottom: 10px;
            color: #4a5568;
        }
        
        video {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            background: #000;
            border: 2px solid #cbd5e0;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-primary {
            background: #48bb78;
            color: white;
        }
        
        .btn-primary:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-warning:hover {
            background: #dd6b20;
        }
        
        .btn-test {
            background: #9f7aea;
            color: white;
        }
        
        .btn-test:hover {
            background: #805ad5;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            background: #ebf8ff;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
            color: #2b6cb0;
            border: 2px solid #bee3f8;
        }
        
        .status.error {
            background: #fed7d7;
            color: #c53030;
            border-color: #feb2b2;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #276749;
            border-color: #9ae6b4;
        }
        
        .debug-info {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .video-container {
                grid-template-columns: 1fr;
            }
            
            .cities-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• –í–∏–¥–µ–æ—á–∞—Ç –∑–Ω–∞–∫–æ–º—Å—Ç–≤ –ø–æ –≥–æ—Ä–æ–¥–∞–º –†–æ—Å—Å–∏–∏</h1>
        
        <div id="app">
            <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
            
            <!-- –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ -->
            <div id="citySelection">
                <h2 style="text-align: center; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥:</h2>
                <div class="cities-grid" id="citiesGrid">
                    <!-- –ì–æ—Ä–æ–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
            
            <!-- –í–∏–¥–µ–æ—á–∞—Ç -->
            <div id="videoChat" style="display: none;">
                <div class="status" id="chatStatus">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="videoChat.findPartner()" id="findBtn">
                        üîç –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                    </button>
                    <button class="btn btn-danger" onclick="videoChat.endCall()" id="endBtn" style="display: none;">
                        üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
                    </button>
                    <button class="btn btn-warning" onclick="videoChat.leaveCity()">
                        üö™ –°–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥
                    </button>
                    <button class="btn btn-test" onclick="videoChat.testCamera()">
                        üß™ –¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã
                    </button>
                </div>
                
                <div class="video-container">
                    <div class="video-box">
                        <h3>–í–∞—à–∞ –∫–∞–º–µ—Ä–∞</h3>
                        <video id="localVideo" autoplay muted playsinline></video>
                        <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #718096;">
                            –°—Ç–∞—Ç—É—Å: <span id="localStatus">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                        </div>
                    </div>
                    
                    <div class="video-box">
                        <h3>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</h3>
                        <video id="remoteVideo" autoplay playsinline></video>
                        <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #718096;">
                            –°—Ç–∞—Ç—É—Å: <span id="remoteStatus">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>
                        </div>
                    </div>
                </div>
                
                <div class="debug-info" id="debugInfo">
                    –ñ—É—Ä–Ω–∞–ª –æ—Ç–ª–∞–¥–∫–∏ –±—É–¥–µ—Ç –∑–¥–µ—Å—å...
                </div>
            </div>
        </div>
    </div>

    <script>
        class VideoChat {
            constructor() {
                this.socket = null;
                this.currentCity = '';
                this.partnerId = null;
                this.peerConnection = null;
                this.localStream = null;
                this.isConnected = false;
                
                this.russianCities = [
                    '–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å',
                    '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', '–ß–µ–ª—è–±–∏–Ω—Å–∫', '–°–∞–º–∞—Ä–∞', '–û–º—Å–∫', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É',
                    '–£—Ñ–∞', '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', '–í–æ—Ä–æ–Ω–µ–∂', '–ü–µ—Ä–º—å', '–í–æ–ª–≥–æ–≥—Ä–∞–¥',
                    '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä', '–°–∞—Ä–∞—Ç–æ–≤', '–¢—é–º–µ–Ω—å', '–¢–æ–ª—å—è—Ç—Ç–∏', '–ò–∂–µ–≤—Å–∫'
                ];
                
                this.init();
            }
            
            init() {
                this.renderCities();
                this.connectToServer();
                this.updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...', 'default');
            }
            
            renderCities() {
                const citiesGrid = document.getElementById('citiesGrid');
                citiesGrid.innerHTML = this.russianCities.map(city => `
                    <button class="city-btn" onclick="videoChat.joinCity('${city}')">
                        üèôÔ∏è ${city}
                    </button>
                `).join('');
            }
            
            connectToServer() {
                const SOCKET_URL = window.location.hostname === 'localhost' 
                    ? 'http://localhost:5000' 
                    : 'https://videochat-app-shtef.onrender.com';
                
                this.log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É: ${SOCKET_URL}`);
                
                this.socket = io(SOCKET_URL, {
                    transports: ['websocket', 'polling']
                });
                
                this.socket.on('connect', () => {
                    this.isConnected = true;
                    this.updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'success');
                    this.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                });
                
                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.updateStatus('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                    this.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ');
                });
                
                this.socket.on('room-joined', (city) => {
                    this.log(`–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ: ${city}`);
                });
                
                this.socket.on('partner-found', (partnerId) => {
                    this.log(`–ù–∞–π–¥–µ–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫: ${partnerId}`);
                    this.partnerId = partnerId;
                    this.showVideoChat();
                    this.startWebRTC(partnerId);
                });
                
                this.socket.on('waiting-for-partner', () => {
                    this.updateStatus('üîç –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –≤ –≤–∞—à–µ–º –≥–æ—Ä–æ–¥–µ...', 'default');
                    this.log('–û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
                });
                
                this.socket.on('partner-disconnected', () => {
                    this.updateStatus('‚ùå –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è', 'error');
                    this.log('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
                    this.endCall();
                });
                
                this.socket.on('call-ended', () => {
                    this.updateStatus('üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'default');
                    this.log('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫');
                    this.endCall();
                });
                
                // WebRTC —Å–æ–±—ã—Ç–∏—è
                this.socket.on('webrtc-offer', (offer, from) => {
                    this.log(`–ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${from}`);
                    this.handleOffer(offer, from);
                });
                
                this.socket.on('webrtc-answer', (answer, from) => {
                    this.log(`–ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${from}`);
                    this.handleAnswer(answer);
                });
                
                this.socket.on('webrtc-ice-candidate', (candidate, from) => {
                    this.log(`–ü–æ–ª—É—á–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç ${from}`);
                    this.handleIceCandidate(candidate);
                });
            }
            
            async joinCity(city) {
                if (!this.isConnected) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É');
                    return;
                }
                
                this.currentCity = city;
                this.socket.emit('join-city-room', city);
                this.updateStatus(`üìç –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –≥–æ—Ä–æ–¥—É: ${city}`, 'success');
                this.log(`–í—ã–±—Ä–∞–Ω –≥–æ—Ä–æ–¥: ${city}`);
                
                await this.startCamera();
                this.showVideoChat();
            }
            
            async startCamera() {
                this.log('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                this.updateLocalStatus('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...');
                
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            frameRate: { ideal: 30 }
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    const localVideo = document.getElementById('localVideo');
                    localVideo.srcObject = this.localStream;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–∫–∏
                    const videoTracks = this.localStream.getVideoTracks();
                    const audioTracks = this.localStream.getAudioTracks();
                    
                    this.log(`‚úÖ –ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞: ${videoTracks.length} –≤–∏–¥–µ–æ —Ç—Ä–µ–∫(–æ–≤)`);
                    this.log(`‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω: ${audioTracks.length} –∞—É–¥–∏–æ —Ç—Ä–µ–∫(–æ–≤)`);
                    
                    if (videoTracks.length > 0) {
                        this.updateLocalStatus(`–ê–∫—Ç–∏–≤–Ω–∞ (${videoTracks[0].label || '–∫–∞–º–µ—Ä–∞'})`);
                    }
                    
                    videoTracks[0].onended = () => {
                        this.updateLocalStatus('–û—Ç–∫–ª—é—á–µ–Ω–∞');
                        this.log('–í–∏–¥–µ–æ —Ç—Ä–µ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
                    };
                    
                } catch (error) {
                    this.log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞: ${error.name} - ${error.message}`);
                    this.updateLocalStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞');
                    
                    let message = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É. ';
                    switch(error.name) {
                        case 'NotAllowedError':
                            message += '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                            break;
                        case 'NotFoundError':
                            message += '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
                            break;
                        case 'NotSupportedError':
                            message += '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ—á–∞—Ç.';
                            break;
                        case 'NotReadableError':
                            message += '–ö–∞–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                            break;
                        default:
                            message += `–û—à–∏–±–∫–∞: ${error.message}`;
                    }
                    
                    alert(message);
                }
            }
            
            findPartner() {
                if (!this.currentCity) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥');
                    return;
                }
                
                this.log(`–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –≤ –≥–æ—Ä–æ–¥–µ: ${this.currentCity}`);
                this.socket.emit('find-partner', this.currentCity);
                this.updateStatus('üîç –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...', 'default');
            }
            
            startWebRTC(partnerId) {
                if (!this.localStream) {
                    this.log('‚ùå –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }
                
                this.log(`–ó–∞–ø—É—Å–∫ WebRTC —Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º: ${partnerId}`);
                
                try {
                    this.peerConnection = new RTCPeerConnection({
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            {
                                urls: 'turn:openrelay.metered.ca:80',
                                username: 'openrelayproject',
                                credential: 'openrelayproject'
                            },
                            {
                                urls: 'turn:openrelay.metered.ca:443',
                                username: 'openrelayproject',
                                credential: 'openrelayproject'
                            },
                            {
                                urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                                username: 'openrelayproject',
                                credential: 'openrelayproject'
                            }
                        ]
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                        this.log(`–î–æ–±–∞–≤–ª–µ–Ω —Ç—Ä–µ–∫: ${track.kind}`);
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
                    this.peerConnection.ontrack = (event) => {
                        this.log('‚úÖ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫');
                        const remoteVideo = document.getElementById('remoteVideo');
                        remoteVideo.srcObject = event.streams[0];
                        this.updateRemoteStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω');
                        
                        event.streams[0].getTracks().forEach(track => {
                            track.onended = () => {
                                this.updateRemoteStatus('–û—Ç–∫–ª—é—á–µ–Ω');
                                this.log('–£–¥–∞–ª–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
                            };
                        });
                    };
                    
                    // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            this.socket.emit('webrtc-ice-candidate', event.candidate, partnerId);
                            this.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç');
                        }
                    };
                    
                    this.peerConnection.oniceconnectionstatechange = () => {
                        this.log(`ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${this.peerConnection.iceConnectionState}`);
                    };
                    
                    // –°–æ–∑–¥–∞–µ–º offer
                    this.peerConnection.createOffer()
                        .then(offer => {
                            this.log('–°–æ–∑–¥–∞–Ω WebRTC offer');
                            return this.peerConnection.setLocalDescription(offer);
                        })
                        .then(() => {
                            this.socket.emit('webrtc-offer', this.peerConnection.localDescription, partnerId);
                            this.log('Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É');
                        })
                        .catch(error => {
                            this.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ${error}`);
                        });
                        
                } catch (error) {
                    this.log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebRTC: ${error}`);
                }
            }
            
            async handleOffer(offer, from) {
                if (!this.peerConnection) return;
                
                try {
                    this.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ offer');
                    await this.peerConnection.setRemoteDescription(offer);
                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);
                    this.socket.emit('webrtc-answer', answer, from);
                    this.log('Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É');
                } catch (error) {
                    this.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${error}`);
                }
            }
            
            async handleAnswer(answer) {
                if (!this.peerConnection) return;
                
                try {
                    this.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ answer');
                    await this.peerConnection.setRemoteDescription(answer);
                    this.log('WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    this.updateStatus('‚úÖ –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω', 'success');
                } catch (error) {
                    this.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer: ${error}`);
                }
            }
            
            async handleIceCandidate(candidate) {
                if (!this.peerConnection) return;
                
                try {
                    await this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    this.log('ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
                } catch (error) {
                    this.log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error}`);
                }
            }
            
            endCall() {
                this.log('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞');
                
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }
                
                if (this.partnerId) {
                    this.socket.emit('end-call');
                    this.partnerId = null;
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo.srcObject) {
                    remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                    remoteVideo.srcObject = null;
                }
                
                this.updateRemoteStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                this.updateStatus('–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞', 'default');
                this.toggleCallButtons(false);
            }
            
            leaveCity() {
                this.log('–í—ã—Ö–æ–¥ –∏–∑ –≥–æ—Ä–æ–¥–∞');
                this.endCall();
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }
                
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = null;
                
                this.currentCity = '';
                this.updateLocalStatus('–ù–µ–∞–∫—Ç–∏–≤–Ω–∞');
                this.updateRemoteStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                this.updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å', 'default');
                
                this.showCitySelection();
            }
            
            testCamera() {
                if (this.localStream) {
                    const videoTracks = this.localStream.getVideoTracks();
                    const audioTracks = this.localStream.getAudioTracks();
                    
                    alert(`‚úÖ –ö–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!\n–í–∏–¥–µ–æ: ${videoTracks.length} —Ç—Ä–µ–∫(–æ–≤)\n–ê—É–¥–∏–æ: ${audioTracks.length} —Ç—Ä–µ–∫(–æ–≤)`);
                    this.log('–¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã: OK');
                } else {
                    alert('‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∞.');
                    this.log('–¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã: –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
                }
            }
            
            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            showVideoChat() {
                document.getElementById('citySelection').style.display = 'none';
                document.getElementById('videoChat').style.display = 'block';
                this.toggleCallButtons(false);
            }
            
            showCitySelection() {
                document.getElementById('citySelection').style.display = 'block';
                document.getElementById('videoChat').style.display = 'none';
            }
            
            toggleCallButtons(inCall) {
                document.getElementById('findBtn').style.display = inCall ? 'none' : 'block';
                document.getElementById('endBtn').style.display = inCall ? 'block' : 'none';
            }
            
            updateStatus(message, type = 'default') {
                const statusElement = document.getElementById('chatStatus');
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
            }
            
            updateLocalStatus(status) {
                document.getElementById('localStatus').textContent = status;
            }
            
            updateRemoteStatus(status) {
                document.getElementById('remoteStatus').textContent = status;
            }
            
            log(message) {
                const debugInfo = document.getElementById('debugInfo');
                const timestamp = new Date().toLocaleTimeString();
                debugInfo.innerHTML = `[${timestamp}] ${message}<br>` + debugInfo.innerHTML;
                console.log(`[VideoChat] ${message}`);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        let videoChat;
        window.addEventListener('load', () => {
            videoChat = new VideoChat();
        });
    </script>
</body>
</html>