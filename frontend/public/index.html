<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–í–∏–¥–µ–æ—á–∞—Ç –ø–æ –≥–æ—Ä–æ–¥–∞–º –†–æ—Å—Å–∏–∏</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f2f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .cities {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        .city-btn {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .city-btn:hover {
            background: #45a049;
        }
        .video-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }
        .video-box {
            text-align: center;
        }
        video {
            width: 400px;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: #000;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background: #e3f2fd;
            border-radius: 5px;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .video-container {
                flex-direction: column;
                align-items: center;
            }
            video {
                width: 100%;
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• –í–∏–¥–µ–æ—á–∞—Ç –∑–Ω–∞–∫–æ–º—Å—Ç–≤ –ø–æ –≥–æ—Ä–æ–¥–∞–º –†–æ—Å—Å–∏–∏</h1>
        <div id="status" class="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
        
        <div id="citySelection">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥:</h2>
            <div class="cities" id="citiesList">
                <!-- –ì–æ—Ä–æ–¥–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
        
        <div id="videoChat" style="display: none;">
            <div class="controls">
                <button class="btn btn-primary" onclick="findPartner()">üîç –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</button>
                <button class="btn btn-danger" onclick="endCall()" style="display: none;">üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
                <button class="btn btn-warning" onclick="leaveCity()">üö™ –°–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥</button>
            </div>
            
            <div class="video-container">
                <div class="video-box">
                    <h3>–í–∞—à–µ –≤–∏–¥–µ–æ</h3>
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
                <div class="video-box">
                    <h3>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</h3>
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const SOCKET_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000' 
            : 'https://videochat-app-shtef.onrender.com';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket;
        let currentCity = '';
        let partnerId = null;
        let peerConnection;
        let localStream;

        const cities = [
            '–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å',
            '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', '–ß–µ–ª—è–±–∏–Ω—Å–∫', '–°–∞–º–∞—Ä–∞', '–û–º—Å–∫', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É',
            '–£—Ñ–∞', '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', '–í–æ—Ä–æ–Ω–µ–∂', '–ü–µ—Ä–º—å', '–í–æ–ª–≥–æ–≥—Ä–∞–¥'
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            renderCities();
            connectToServer();
        }

        function renderCities() {
            const citiesList = document.getElementById('citiesList');
            citiesList.innerHTML = cities.map(city => 
                `<button class="city-btn" onclick="joinCity('${city}')">${city}</button>`
            ).join('');
        }

        function connectToServer() {
            socket = io(SOCKET_URL);

            socket.on('connect', () => {
                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
            });

            socket.on('room-joined', (city) => {
                updateStatus(`‚úÖ –í –∫–æ–º–Ω–∞—Ç–µ: ${city}`);
            });

            socket.on('partner-found', (foundPartnerId) => {
                partnerId = foundPartnerId;
                updateStatus('‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω!');
                startWebRTC(foundPartnerId);
                document.querySelector('.btn-primary').style.display = 'none';
                document.querySelector('.btn-danger').style.display = 'inline-block';
            });

            socket.on('waiting-for-partner', () => {
                updateStatus('üîç –ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
            });

            socket.on('partner-disconnected', () => {
                updateStatus('‚ùå –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
                endCall();
            });

            // WebRTC —Å–æ–±—ã—Ç–∏—è
            socket.on('webrtc-offer', handleOffer);
            socket.on('webrtc-answer', handleAnswer);
            socket.on('webrtc-ice-candidate', handleIceCandidate);
        }

        async function joinCity(city) {
            currentCity = city;
            socket.emit('join-city-room', city);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                document.getElementById('localVideo').srcObject = localStream;
                updateStatus(`‚úÖ –ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤ –≥–æ—Ä–æ–¥–µ: ${city}`);
            } catch (error) {
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                return;
            }
            
            document.getElementById('citySelection').style.display = 'none';
            document.getElementById('videoChat').style.display = 'block';
        }

        function findPartner() {
            if (!currentCity) return;
            socket.emit('find-partner', currentCity);
        }

        function startWebRTC(targetPartnerId) {
            if (!localStream) return;

            // –°–æ–∑–¥–∞–µ–º PeerConnection —Å –Ω–∞–¥–µ–∂–Ω—ã–º–∏ TURN —Å–µ—Ä–≤–µ—Ä–∞–º–∏
            peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    {
                        urls: 'turn:openrelay.metered.ca:80',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    },
                    {
                        urls: 'turn:openrelay.metered.ca:443',
                        username: 'openrelayproject', 
                        credential: 'openrelayproject'
                    },
                    {
                        urls: 'turn:turn.quickblox.com:3478',
                        username: 'quickblox',
                        credential: 'baccb97ba2d92d71e26eb7c'
                    }
                ]
            });

            // –ö–ª—é—á–µ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –ü–†–ê–í–ò–õ–¨–ù–û
            localStream.getTracks().forEach(track => {
                console.log('Adding track:', track.kind);
                peerConnection.addTrack(track, localStream);
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –≤–∏–¥–µ–æ - —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ!
            peerConnection.ontrack = (event) => {
                console.log('Received remote track:', event.track.kind);
                const remoteVideo = document.getElementById('remoteVideo');
                if (event.streams && event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-ice-candidate', event.candidate, targetPartnerId);
                }
            };

            // –°–æ–∑–¥–∞–µ–º offer
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    socket.emit('webrtc-offer', peerConnection.localDescription, targetPartnerId);
                })
                .catch(console.error);
        }

        async function handleOffer(offer, from) {
            if (!peerConnection) return;
            
            await peerConnection.setRemoteDescription(offer);
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('webrtc-answer', answer, from);
        }

        async function handleAnswer(answer) {
            if (!peerConnection) return;
            await peerConnection.setRemoteDescription(answer);
        }

        async function handleIceCandidate(candidate) {
            if (!peerConnection) return;
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            partnerId = null;
            
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                remoteVideo.srcObject = null;
            }
            
            document.querySelector('.btn-primary').style.display = 'inline-block';
            document.querySelector('.btn-danger').style.display = 'none';
            updateStatus('–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É');
        }

        function leaveCity() {
            endCall();
            currentCity = '';
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('citySelection').style.display = 'block';
            document.getElementById('videoChat').style.display = 'none';
            updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥');
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', init);
    </script>
</body>
</html>