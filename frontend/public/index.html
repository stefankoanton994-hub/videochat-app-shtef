<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–í–∏–¥–µ–æ—á–∞—Ç –ø–æ –≥–æ—Ä–æ–¥–∞–º –†–æ—Å—Å–∏–∏</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .video-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        video {
            width: 400px;
            height: 300px;
            border: 3px solid #fff;
            border-radius: 10px;
            background: #000;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .cities {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        .city-btn {
            background: #4CAF50;
            color: white;
        }
        .find-btn {
            background: #2196F3;
            color: white;
        }
        .end-btn {
            background: #f44336;
            color: white;
        }
        .leave-btn {
            background: #ff9800;
            color: white;
        }
        .status {
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• –í–∏–¥–µ–æ—á–∞—Ç –∑–Ω–∞–∫–æ–º—Å—Ç–≤ –ø–æ –≥–æ—Ä–æ–¥–∞–º –†–æ—Å—Å–∏–∏</h1>
        <div id="app"></div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const SOCKET_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000' 
            : 'https://videochat-app-shtef.onrender.com';

        // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        class VideoChat {
            constructor() {
                this.socket = null;
                this.currentCity = '';
                this.status = 'disconnected';
                this.partnerId = null;
                this.peerConnection = null;
                this.localStream = null;
                
                this.russianCities = [
                    '–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–ö–∞–∑–∞–Ω—å',
                    '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', '–ß–µ–ª—è–±–∏–Ω—Å–∫', '–°–∞–º–∞—Ä–∞', '–û–º—Å–∫', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É',
                    '–£—Ñ–∞', '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', '–í–æ—Ä–æ–Ω–µ–∂', '–ü–µ—Ä–º—å', '–í–æ–ª–≥–æ–≥—Ä–∞–¥'
                ];
                
                this.init();
            }

            init() {
                this.render();
                this.connectToServer();
            }

            connectToServer() {
                this.socket = io(SOCKET_URL, {
                    transports: ['websocket', 'polling']
                });

                this.socket.on('connect', () => {
                    this.updateStatus('connected');
                    console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É');
                });

                this.socket.on('room-joined', (city) => {
                    this.updateStatus(`–≤ –∫–æ–º–Ω–∞—Ç–µ ${city}`);
                });

                this.socket.on('partner-found', (partnerId) => {
                    this.partnerId = partnerId;
                    this.updateStatus('–≤ –∑–≤–æ–Ω–∫–µ');
                    this.startWebRTC(partnerId);
                });

                this.socket.on('waiting-for-partner', () => {
                    this.updateStatus('–ø–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
                });

                this.socket.on('partner-disconnected', () => {
                    this.updateStatus('—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
                    this.endCall();
                });

                this.socket.on('call-ended', () => {
                    this.updateStatus('–∑–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
                    this.endCall();
                });

                // WebRTC —Å–æ–±—ã—Ç–∏—è
                this.socket.on('webrtc-offer', this.handleOffer.bind(this));
                this.socket.on('webrtc-answer', this.handleAnswer.bind(this));
                this.socket.on('webrtc-ice-candidate', this.handleIceCandidate.bind(this));
            }

            async joinCity(city) {
                if (!this.socket) return;
                
                this.currentCity = city;
                this.socket.emit('join-city-room', city);
                this.updateStatus(`–ø–æ–¥–∫–ª—é—á–µ–Ω –∫ ${city}`);
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: true 
                    });
                    document.getElementById('localVideo').srcObject = this.localStream;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                }
                
                this.render();
            }

            findPartner() {
                if (!this.socket || !this.currentCity) return;
                this.socket.emit('find-partner', this.currentCity);
                this.updateStatus('–ø–æ–∏—Å–∫...');
            }

            startWebRTC(partnerId) {
                if (!this.localStream) return;

                // –°–æ–∑–¥–∞–µ–º PeerConnection —Å TURN —Å–µ—Ä–≤–µ—Ä–∞–º–∏
                this.peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        {
                            urls: 'turn:openrelay.metered.ca:80',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        }
                    ]
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
                this.localStream.getTracks().forEach(track => {
                    this.peerConnection.addTrack(track, this.localStream);
                });

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
                this.peerConnection.ontrack = (event) => {
                    console.log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };

                // –û–±–º–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏
                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.socket.emit('webrtc-ice-candidate', event.candidate, partnerId);
                    }
                };

                // –°–æ–∑–¥–∞–µ–º offer
                this.peerConnection.createOffer()
                    .then(offer => this.peerConnection.setLocalDescription(offer))
                    .then(() => {
                        this.socket.emit('webrtc-offer', 
                            this.peerConnection.localDescription, 
                            partnerId
                        );
                    })
                    .catch(console.error);
            }

            async handleOffer(offer, from) {
                if (!this.peerConnection) return;
                
                await this.peerConnection.setRemoteDescription(offer);
                const answer = await this.peerConnection.createAnswer();
                await this.peerConnection.setLocalDescription(answer);
                this.socket.emit('webrtc-answer', answer, from);
            }

            async handleAnswer(answer) {
                if (!this.peerConnection) return;
                await this.peerConnection.setRemoteDescription(answer);
            }

            async handleIceCandidate(candidate) {
                if (!this.peerConnection) return;
                await this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }

            endCall() {
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }
                if (this.partnerId) {
                    this.socket.emit('end-call');
                    this.partnerId = null;
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo.srcObject) {
                    remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                    remoteVideo.srcObject = null;
                }
                
                this.updateStatus(`–≤ –∫–æ–º–Ω–∞—Ç–µ ${this.currentCity}`);
                this.render();
            }

            leaveCity() {
                this.endCall();
                this.currentCity = '';
                this.updateStatus('connected');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }
                
                const localVideo = document.getElementById('localVideo');
                if (localVideo) localVideo.srcObject = null;
                
                this.render();
            }

            updateStatus(newStatus) {
                this.status = newStatus;
                this.renderStatus();
            }

            renderStatus() {
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = `–°—Ç–∞—Ç—É—Å: ${this.status}`;
                }
            }

            render() {
                const app = document.getElementById('app');
                
                if (!this.currentCity) {
                    // –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞
                    app.innerHTML = `
                        <div>
                            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥:</h2>
                            <div class="cities">
                                ${this.russianCities.map(city => `
                                    <button class="city-btn" onclick="videoChat.joinCity('${city}')">
                                        ${city}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // –≠–∫—Ä–∞–Ω –≤–∏–¥–µ–æ—á–∞—Ç–∞
                    app.innerHTML = `
                        <div>
                            <h2>–ì–æ—Ä–æ–¥: ${this.currentCity}</h2>
                            <div id="status" class="status">–°—Ç–∞—Ç—É—Å: ${this.status}</div>
                            
                            <div>
                                ${!this.partnerId ? `
                                    <button class="find-btn" onclick="videoChat.findPartner()">
                                        üîç –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                                    </button>
                                ` : `
                                    <button class="end-btn" onclick="videoChat.endCall()">
                                        üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
                                    </button>
                                `}
                                
                                <button class="leave-btn" onclick="videoChat.leaveCity()">
                                    üö™ –ü–æ–∫–∏–Ω—É—Ç—å –≥–æ—Ä–æ–¥
                                </button>
                            </div>
                            
                            <div class="video-container">
                                <div>
                                    <h3>–í–∞—à–µ –≤–∏–¥–µ–æ:</h3>
                                    <video id="localVideo" autoplay muted playsinline></video>
                                </div>
                                <div>
                                    <h3>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫:</h3>
                                    <video id="remoteVideo" autoplay playsinline></video>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const videoChat = new VideoChat();
    </script>
</body>
</html>